---
layout: post
title: "Thread 개념 잡고 넘어가기"
subtitle: "이제서야 잡는 Thread"
author: "GuGyu"
header-style: text
tags:
  - Thread
  - Study
  - Java
  - Process
---
`Thread`(이하 스레드) 라는 말은 정말 많이 들어보았다. 어떤 개발을 하던간에 예제소스에서 쉽게 스레드에 관한 부분을 찾아볼 수 있었고 컴퓨터 공학 전공 과목에서도 익히 들어왔다.  
그러나 스레드가 뭐냐고 묻는다면 자신있게 대답할 수 없었다. 그래서 이번 기회에 스레드의 개념을 확실히 잡아보려 한다.  
  

### 프로그램과 프로세스

프로그램은 컴퓨터에 의해 실행되는 명령과 데이터의 집합을 말한다. (대부분)파일의 형태로 저장되어 CPU에 의해 메모리로 로딩되고 실행된다. 초창기 컴퓨터에서는 동시에 하나의 프로그램만 실행할 수 있었고 다른 프로그램을 실행하기 위해서는 먼저 실행하던 프로그램을 종료한 후에 실행할 수 있었다. 이후 많은 발전을 통해서 동시에 여러 프로그램을 실행할 수 있는 멀티 프로그램 환경을 완성할 수 있었다.  
  
  
그 이후 운영체제가 빠르게 발전하면서 기존에는 프로그램이 컴퓨터 하드웨어에 의해 직접 실행되었으나 운영체제가 프로그램의 실행을 담당하게 되었다. 운영체제는 컴퓨터 하드웨어 리소스를 관리하고 있기 때문에 프로그램의 실행까지 맡게 되면 시스템 효율 측면에서 이득이 된다. 시스템 리소스가 특정 프로그램에 의해 관리되지 않고 운영체제에 의해 유연하게 관리되기 때문에 여러 개의 프로그램을 동시에 혹은 하나의 프로그램을 동시에 여러 개 실행할 수 있는 것이다.  
  
  
그럼 프로세스는 무엇일까?  
프로세스는 운영체제에 의해 메모리에 적재되어 실행 중인 프로그램을 의미한다.

### 프로세스와 스레드

운영체제에 의해 프로그램이 메모리에 적재되어 프로세스가 실행되면, 프로세스는 코드의 시작점부터 종료지점까지 순차적인 실행 흐름을 가진다. 그러나 많은 경우 하나의 코드 실행 흐름만으로 처리하기 힘든 동작을 구현해야할 때가 많다. 쉽게 예를 들 수 있는 건 입출력 동작이다. 하드웨어의 입출력 속도는 CPU의 연산 속도에 비하면 매우 느린데, 저장 공간에 어떠한 데이터를 저장하는 코드를 실행하고 있다면 다른 코드는 그동안 실행될 수 없다. 이럴 경우 스레드를 이용할 수 있다.  
  
  
저장 공간에 데이터를 저장하는 코드의 흐름을 별도로 생성한다면 그 동안 다른 코드를 실행할 수 있다. 두 가지 작업을 동시에 처리하는 것이다. 이렇듯 플세스 내에서 실행되는 각각의 독립적인 실행 흐름을 스레드(`Thread`)라고 한다. 또한 하나의 프로세스 내에서 두 개 이상의 스레드가 동작하도록 프로그래밍 하는 것을 멀티스레드 프로그래밍이라고 한다.

### 메인 스레드

스레드는 프로세스 실행 중 언제든지 필요에 따라 만들어지고 실행될 수 있으나 이러한 작업 또한 실행 중인 스레드에서 수행되어야 한다. 그렇다면 스레드들의 최초 시작점이 되는 스레드가 존재하지 않을까? 이 최초의 스레드가 바로 메인 스레드이다.  
  
  
메인 스레드는 프로세스가 시작될 때 최초의 실행 시작점이 된다.

### 안드로이드 스레드

안드로이드의 스레드를 파악하기 위해선 먼저 메인 스레드를 알아야 한다. 그런데 안드로이드는 명확한 코드의 시작점을 찾아보기 어렵다. 일반적으로는 `main()` 메서드를 구현해 시작점을 명시하지만 안드로이드에서는 앱에 포함된 액티비티 중 하나를 런처로 지정하여 해당 액티비티를 앱의 시작점으로 만들 수 있고 이는 `AndroidMainifest.xml`에서 수행할 수 있다.  
  
  
물론 그렇다고 해서 안드로이드에 `main()`함수가 존재하지 않거나 앱이 실행될 때 아무런 준비 과정 없이 런쳐 액티비티부터 실행되는 것은 아니다. 개발자가 직접 `main()`함수를 작성하지 않았을 뿐이지 안드로이드 프레임워크에 이미 구현되어 있다. 이는 "android.app.ActivityThread" 클래스에서 확인할 수 있다.  
  
  
`ActivityThread`클래스의 `main()` 함수에는 안드로이드 프레임워크 상에서 앱의 동작에 필요한 여러 준비 동작을 수행하는데 그 중 가장 중요한 것이 바로 메인 UI 스레드를 실행하는 것이다. 그 이후에나 런처로 지정된 액티비티가 실행된다.

### 메인 UI 스레드

보통 사용자의 입력(키보드, 마우스, 터치 등)을 취급하는 프로그램에서는 코드의 시작부터 종료까지 순차적으로 실행되어 끝나는 경우는 거의 없다. 사용자 입력에 대한 이벤트를 처리하기 위해서는 루프(Loop)가 필요하다. 사용자의 입력을 기다리는 어떠한 루프를 지속적으로 돌리고 있어야 하는 것이다.  
  
  
그렇다고 해서 사용자의 입력을 기다리는 for문이나 while문을 무작정 돌리고 있는 것은 아니다. 사용자의 입력이 들어올 때 까지 해당 반복문을 계속 돌리고 있으면 다른 이벤트를 처리할 수 없고 그 자체가 시스템 자원을 소모시키게 된다. 따라서 이벤트 처리를 위한 루프는 아주 신중하게 작성되어야 하고 이를 위해 UI 프레임워크는 메시지 큐(Message Queue)를 사용한다.  
  
  
메시지 큐는 사용자 입력을 포함한 시스템의 모든 이벤트를 전달할 때 사용하는 객체이다. 스레드의 관점에서 메시지 큐는 시스템 이벤트를 발생 순서대로 전달받아 처리하기 위해 사용하는 구조이다. 시스템(또는 프로세스)에서 발생한 새로운 메시지가 메시지 큐에 수신되면 메시지가 담고 있는 내용에 따라 적절한 핸들러 메서드가 호출된다. 하지만 시스템에서 발생 가능한 모든 이벤트를 처리할 필요는 없으니 필요한 이벤트에 대한 메시지를 핸들러로 등록하고 호출되게 만들면 된다.  
![](https://t1.daumcdn.net/cfile/tistory/99F9DE4F5BB7214D19)  
<출처 - [https://t1.daumcdn.net/cfile/tistory/99F9DE4F5BB7214D19>](https://t1.daumcdn.net/cfile/tistory/99F9DE4F5BB7214D19>)

안드로이드 앱에서는 루프와 핸들러의 역할을 수행하는 클래스 구현을 통해 UI 스레드를 작성할 수 있도록 해준다.  
먼저 루프는 `Looper`라는 클래스를 통해 실행된다. 이 클래스의 주 역할은 루프를 실행하고 루프 안에서 메시지 큐로 전달하는 메시지가 존재하는지 검사하는 것이다. 그리고 새로운 메시지가 도착하면 해당 메시지를 처리할 핸들러 메서드를 실행한다.  
  
  
안드로이드의 핸들러는 `Hander` 클래스가 담당한다. 통상적인 개념에서 핸들러는 메시지 수신 시 그 처리를 담당하는 역할만 수행하는데 안드로이드에서 `Handler`는 메시지를 보내는 역할까지 포함한다. 즉 `Handler`는 `Looper`가 가진 메시지 큐를 다룰 수 있기 때문에 새로운 메시지를 보내거나 수신된 메시지에 대한 처리를 담당하는 주체가 된다.  
![](https://t1.daumcdn.net/cfile/tistory/99F68F465BB735DB11)  
<출처 - [https://t1.daumcdn.net/cfile/tistory/99F68F465BB735DB11>](https://t1.daumcdn.net/cfile/tistory/99F68F465BB735DB11>)  
  

### 안드로이드 메인 UI의 역할 : 화면 그리기

대부분의 GUI를 가지는 프레임워크에서 그리기 기능은 메인 UI 스레드에서 실행되어야만 한다. 여러 스레드에서 나눠 그리게 되면 어쩌다 먼저 실행되는 스레드가 그린 이미지는 다음 스레드가 그린 이미지에 가려져 원하는 결과를 얻지 못할 수도 있다. 즉 UI를 제대로 표시하기 위해서는 각 요소를 그리는 순서가 절대적으로 중요하기 때문에 하나의 스레드 (메인 UI 스레드)에서 순차적으로 그리도록 만들어야 한다.  
  

### 참고

[안드로이드 스레드(Android Thread)](https://recipes4dev.tistory.com/143)